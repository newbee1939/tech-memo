# 読書メモ

## Web ページの速度（フロントエンドエンジニア）

- ページロード（ページが表示されるまでの速度）
  - HTML,CSS,JavaScript,画像のロード
  - レンダーツリーの構築
  - 描画処理の実行
- ランタイム（ページ上での操作に対する UI の応答速度）

  - スクロール操作
  - アニメーション
  - UI の切り替え
    - など

## Web ページの速度はフロントエンドが一番重要

- エンドユーザーに対するレスポンスタイムのうち 80%から 90%は Web フロントエンドで発生している

## Web フロントエンドを高速化する 3 つのポイント

- ネットワーク処理
  - サーバーから配信される HTML,CSS,JS,画像などのリソースをブラウザがダウンロードする処理
  - ダウンロードするリソースの数やファイルサイズを最適化することが重要
- レンダリング処理
  - ディスプレイへの表示
- スクリプト処理
  - JavaScript による演算や DOM 操作

## Web フロントエンド高速化への取り組み方

- !!推測するな、計測せよ!!
  - Measure, Don't Guess
- いきなりコードを眺めて修正し始めるのはダメ
- 先ずは現在の速度を測る
- なぜページロードが遅いのか、なぜランタイムの UI が鈍いのかを計測によって特定し、それを取り除くことで行うべき

## ページロード速度を左右するネットワーク処理

- 理想のページロード時間は 1 秒以内
- ネットワークの処理速度に影響を与える要素
  - リソースの大きさ(ファイルサイズ)
  - HTTP リクエストの数
    - 無駄なサブリソースが含まれないように気を遣うべき
  - ネットワークの通信距離

## ネットワーク処理の流れ

1. DNS ルックアップ

- ホスト名の解決
- 対応する IP アドレスの返却

2. TCP3 ウェイハンドシェイク

- サーバへの TCP 接続の要求(SYN)
- サーバからの接続要求に対する応答(SYN-ACK)
- サーバとの TCP 接続開始(ACK)
  - HTTTP は TCP の上位層にあたるプロトコルなので、HTTP によるやり取りの前提として TCP 接続を確立しないといけない

3. HTTP レスポンス

- リクエストに対するサーバからのレスポンス

## ネットワーク処理の基本

- ブラウザが Web ページを表示するまで
  1. 指定された URL から HTML 取得
  2. HTML に応じてサブリソースを取得してページを表示する（フロントエンドの実装に起因する）
  - 2 が大きな遅延の原因となっている
  - ここの改善がネットワークの高速化に繋がる

## ネットワーク処理最適化の 3 原則

1. データの転送量をなるべく小さく

- リソースは圧縮や最適化
  - JS などは minify

2. データの転送回数をなるべく少なく
3. データの転送距離をなるべく短く

## ネットワークから取得するリソースについて

- それぞれをどのように最適化すれば良いか
- テキスト(HTML,CSS,JavaScript,SVG)
  - minify する
- 画像
  - 写真、バナー、アイコンといった画像の特徴に応じた画像形式の選択と、画像データの圧縮と最適化が必要

## クリティカルレンダリングパス（Web ページが最初にロードされるときのブラウザの内部処理）（レンダリング処理そのものを最適化するのではなく、ページロード時にレンダリング処理に至るまでの時間を最適化する）

※以下は、それぞれが終わらないと下の処理が始められない
※これを最適化できたらページロードの速度改善に繋がる
※いかに早くレンダーツリーの構築を始めさせられるかが重要

1. HTML ドキュメントのダウンロードと評価

- HTML ドキュメントを、ファイルの先頭から順にパースして評価
- DOM ツリーの構築
- <link>、<script>、<img>などの記述に基づいてHTTPリクエストを繰り返す
- DOM ツリーは構築途中なので、レンダリング処理は開始されない

2. サブリソースのダウンロードと評価

- JS や CSS のロード中は、DOM ツリーに影響を与える可能性があるため、レンダリング処理をブロックする

3. レンダーツリーの構築とレンダリング

- 上記の工程で生成されたレンダーツリーをもとに画面上の要素位置の計算等が行われ、レンダリングされる

ここから！

## レンダリング過程の確認方法

- DevTool のフィルムストップ(Performance -> Screenshots をチェックした状態でページリロード)
  - サブリソースのロードやレンダーツリーの構築に応じて、ページがどの程度レンダリングされているかを計測する
  - ボトルネックを明らかにするのに使える

## ネットワーク処理の調査と計測

- DevTool の Network パネル

## プロダクトに応じた指標作り

- アプリによって適切な改善の方針は異なる
- 様々な指標を知って引き出しを増やしておくことで、それぞれのアプリで適切な指標を選択できるようになる
- 表示速度に対する間接的な指標
  - ページロードに関わるブラウザイベント
